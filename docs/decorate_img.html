<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Decorate Image &#8212; MapProxy 1.14.0 Docs</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-sphinx.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Development" href="development.html" />
    <link rel="prev" title="Authentication and Authorization" href="auth.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

<div id="navbar" class="navbar navbar-default ">
  <div class="container">
    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="index.html" class="pull-left"><img src="_static/logo.png" height="50">
      </a>
      <a class="navbar-brand" href="index.html">
        <span>
          MapProxy</span>
        <span>1.14.0</span>
      </a>
    </div>
    <div class="collapse navbar-collapse nav-collapse">
      
        
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="install_windows.html">Installation on Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="install_osgeo4w.html">Installation on OSGeo4W</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="sources.html">Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="caches.html">Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="seed.html">Seeding</a></li>
<li class="toctree-l1"><a class="reference internal" href="coverages.html">Coverages</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapproxy_util.html">mapproxy-util</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapproxy_util_autoconfig.html">mapproxy-util autoconfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration_examples.html">Configuration examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="inspire.html">INSPIRE View Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="labeling.html">WMS Labeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth.html">Authentication and Authorization</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Decorate Image</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#decorate-image-middleware">Decorate Image Middleware</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mapproxy-decorate-image-api">MapProxy Decorate Image API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapproxy_2.html">MapProxy 2.0</a></li>
</ul>

        </div>
      </div>
    <div class="col-md-8">
      
  <section id="decorate-image">
<h1>Decorate Image<a class="headerlink" href="#decorate-image" title="Permalink to this headline">¶</a></h1>
<p>MapProxy provides the ability to update the image produced in response to a WMS GetMap or Tile request prior to it being sent to the client. This can be used to decorate the image in some way such as applying an image watermark or applying an effect.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some Python programming and knowledge of <a class="reference external" href="http://wsgi.org">WSGI</a> and WSGI middleware is required to take advantage of this feature.</p>
</div>
<section id="decorate-image-middleware">
<h2>Decorate Image Middleware<a class="headerlink" href="#decorate-image-middleware" title="Permalink to this headline">¶</a></h2>
<p>The ability to decorate the response image is implemented as WSGI middleware in a similar fashion to how <a class="reference internal" href="auth.html"><span class="doc">authorization</span></a> is handled. You must write a WSGI filter which wraps the MapProxy application in order to register a callback which accepts the ImageSource to be decorated.</p>
<p>The callback is registered by assigning a function to the key <code class="docutils literal notranslate"><span class="pre">decorate_img</span></code> in the WSGI environment. Prior to the image being sent in the response MapProxy checks the environment and calls the callback passing the ImageSource and a number of other parameters related to the current request. The callback must then return a valid ImageSource instance which will be sent in the response.</p>
<section id="wsgi-filter-middleware">
<h3>WSGI Filter Middleware<a class="headerlink" href="#wsgi-filter-middleware" title="Permalink to this headline">¶</a></h3>
<p>A simple middleware that annotates each image with information about the request might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mapproxy.image</span> <span class="k">import</span> <span class="n">ImageSource</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">ImageColor</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>


<span class="k">def</span> <span class="nf">annotate_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">query_extent</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="c1"># Get the PIL image and convert to RGBA to ensure we can use black</span>
    <span class="c1"># for the text</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">as_image</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;service: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">service</span><span class="p">]</span>
    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;layers: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>
    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;srs: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bounds:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">query_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">coord</span><span class="p">)</span>

    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">load_default</span><span class="p">()</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getrgb</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="n">line_y</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">line_w</span><span class="p">,</span> <span class="n">line_h</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_y</span><span class="p">),</span> <span class="n">line</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">)</span>
        <span class="n">line_y</span> <span class="o">=</span> <span class="n">line_y</span> <span class="o">+</span> <span class="n">line_h</span>

    <span class="c1"># Return a new ImageSource specifying the updated PIL image and</span>
    <span class="c1"># the image options from the original ImageSource</span>
    <span class="k">return</span> <span class="n">ImageSource</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">image_opts</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RequestInfoFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple MapProxy decorate_img middleware.</span>

<span class="sd">    Annotates map images with information about the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="c1"># Add the callback to the WSGI environment</span>
        <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;mapproxy.decorate_img&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotate_img</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>You need to wrap the MapProxy application with your custom decorate_img middleware. For deployment scripts it might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">application</span> <span class="o">=</span> <span class="n">make_wsgi_app</span><span class="p">(</span><span class="s1">&#39;./mapproxy.yaml&#39;</span><span class="p">)</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">RequestInfoFilter</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
</pre></div>
</div>
<p>For <a class="reference external" href="http://pythonpaste.org/deploy/">PasteDeploy</a> you can use the <code class="docutils literal notranslate"><span class="pre">filter-with</span></code> option. The <code class="docutils literal notranslate"><span class="pre">config.ini</span></code> looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">app</span><span class="p">:</span><span class="n">mapproxy</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">MapProxy</span><span class="c1">#app</span>
<span class="n">mapproxy_conf</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">here</span><span class="p">)</span><span class="n">s</span><span class="o">/</span><span class="n">mapproxy</span><span class="o">.</span><span class="n">yaml</span>
<span class="nb">filter</span><span class="o">-</span><span class="k">with</span> <span class="o">=</span> <span class="n">requestinfo</span>

<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">requestinfo</span><span class="p">]</span>
<span class="n">paste</span><span class="o">.</span><span class="n">filter_app_factory</span> <span class="o">=</span> <span class="n">mydecoratemodule</span><span class="p">:</span><span class="n">RequestInfoFilter</span>

<span class="p">[</span><span class="n">server</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="mapproxy-decorate-image-api">
<h2>MapProxy Decorate Image API<a class="headerlink" href="#mapproxy-decorate-image-api" title="Permalink to this headline">¶</a></h2>
<p>The signature of the decorate_img function:</p>
<dl class="py function">
<dt class="sig sig-object py" id="decorate_img">
<span class="sig-name descname"><span class="pre">decorate_img</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">image</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">service</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">layers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[]</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">environ</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">query_extent</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kw</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#decorate_img" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>image</strong> – ImageSource instance to be decorated</p></li>
<li><p><strong>service</strong> – service associated with the current request (e.g. <code class="docutils literal notranslate"><span class="pre">wms.map</span></code>, <code class="docutils literal notranslate"><span class="pre">tms</span></code> or <code class="docutils literal notranslate"><span class="pre">wmts</span></code>)</p></li>
<li><p><strong>layers</strong> – list of layer names specified in the request</p></li>
<li><p><strong>environ</strong> – the request WSGI environment</p></li>
<li><p><strong>query_extent</strong> – a tuple of the SRS (e.g. <code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>) and the BBOX
of the request</p></li>
</ul>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>ImageSource</p>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">environ</span></code> and <code class="docutils literal notranslate"><span class="pre">query_extent</span></code> parameters are optional and can be ignored by the callback. The arguments might get extended in future versions of MapProxy. Therefore you should collect further arguments in a catch-all keyword argument (i.e. <code class="docutils literal notranslate"><span class="pre">**kw</span></code>).</p>
</dd></dl>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The actual name of the callable is insignificant, only the environment key <code class="docutils literal notranslate"><span class="pre">mapproxy.decorate_img</span></code> is important.</p>
</div>
<p>The function should return a valid ImageSource instance, either the one passed or a new instance depending the implementation.</p>
</section>
</section>


    </div>
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
    </p>
    <p>
     
       &copy; Copyright Oliver Tonnhofer, Omniscale, <a href="http://mapproxy.org/about">Legal</a>
     
     <br/>
     
       Last updated on 2021-11-24
     <br/>

     
       Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.0.
     
   </p>
 </div>
</footer>
  </body>
</html>